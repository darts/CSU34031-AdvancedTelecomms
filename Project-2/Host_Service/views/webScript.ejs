<script>
    const rsa = new RSA()
    const threadAddr = " https://localhost:3000/thread?thread="
    const homeAddr = " https://localhost:3000/home"
    const newThreadAddr = "https://localhost:3000/newThread"
    const newPostAddr = "https://localhost:3000/newPost"
    const userAddr = "https://localhost:3000/loginCreate"
    let userName, pubKey, privKey
    let curThread;
    rsa.generateKeyPair(function (keyPair) { pubKey = keyPair.publicKey; privKey = keyPair.privateKey; })
    let moveToThread = (threadID) => {
        fetch(threadAddr + threadID).then((res) => {
            return res.json()
        }).then(res => {
            console.log(res)
            document.body.innerHTML = res.html
            curThread = threadID
        }).catch(err => {
            console.log(err)
            alert("Error connecting to server")
        })
    }

    let returnHome = () => {
        fetch(homeAddr).then((res) => {
            return res.json()
        }).then(res => {
            // console.log(res)
            document.body.innerHTML = res.html
        }).catch(err => {
            console.log(err)
            alert("Error connecting to server")
        })
    }

    let postthread = () => {
        let text = document.getElementById('newthread-container').value
        let title = document.getElementById('newthread-title').value
        console.log(JSON.stringify({ user: userName, title: title, content: text }))

        fetch(newThreadAddr, {
            method: "POST",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user: userName, title: title, content: text })
        }).then(res => {
            returnHome()
        })
        // alert("gotta actually send something")
        // console.log(document.getElementById('newthread-container').value)
    }

    let addPost = () => {
        let content = document.getElementById('newthreadPost').value
        fetch(newPostAddr, {
            method: "POST",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user: userName, thread: curThread, 'content': content })
        }).then(res => {
            moveToThread(curThread)
        })
    }

    let login = () => {
        let usrname = document.getElementById('unm').value
        let pwd = document.getElementById('pwd').value
        let isNewUser = !!document.getElementById('newUser').checked

        fetch(userAddr, {
            method: "POST",
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: usrname, password: pwd, isNewUser: isNewUser, privKey: privKey, pubKey: pubKey })
        }).then(res => {
            return res.json()
        }).then(res => {
            privKey = res.privKey
            pubKey = res.pubKey
            userName = usrname

            document.getElementById('popupbox').style.visibility = 'hidden'
            document.getElementById('userlogin').innerText = `Logged in as: ${userName}`
        })
    }

</script>
